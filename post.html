<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Post</title>
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" href="blog.css">
    <link rel="stylesheet" href="postStyle.css">
    <script src="main.js" defer></script>
    <script src="config.js"></script>
</head>
<body>
    <header>
        <div class="logo">
                <a href="index.html">DUSH</a>
            </div>
        <div class="nav">
            <a href="index.html">PORTFOLIO</a>
            <a href="blog.html" class="active">BLOG</a>
            <a href="dashboard.html">DASHBOARD</a>
        </div>
        <div class="nav-actions">
                <div class="hamburger" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="profile-dropdown">
                    <img src="./images/profiles/default.jpg" alt="Profile Picture" class="profile-picture">
                    <div class="dropdown-content">
                        <a href="edit-profile.html">Profile Settings</a>
                        <a href="#" onclick="logout()">Logout</a>
                    </div>
                </div>
        </div>
    </header>
    <div class="mobile-menu" id="mobileMenu">
            <span class="close-menu" id="closeMobileMenu">&times;</span>
            <div class="nav">
                <a href="index.html">PORTFOLIO</a>
                <a href="blog.html" class="active">BLOG</a>
                <a href="dashboard.html">DASHBOARD</a>
            </div>
            <div class="auth-buttons" id="mobileAuthButtons">
                <div class="auth-button login">
                    <a href="login.html">Login</a>
                </div>
                <div class="auth-button register">
                    <a href="register.html">Register</a>
                </div>
            </div>
        </div>
    <main>
        <a href="blog.html" class="back-button">
            <i class="fas fa-arrow-left"></i>
            Back to Blog
        </a>
        <section class="post-detail section" id="postDetailContainer">
            <!-- Post content will be rendered here -->
        </section>
        <section class="post-interactions section" id="postInteractions">
            <button id="likeBtn" class="interaction-btn">
                <i class="far fa-heart"></i> 
                <span id="likeCount">0</span> Like
            </button>
            <button id="bookmarkBtn" class="interaction-btn">
                <i class="far fa-bookmark"></i> 
                Bookmark
            </button>
        </section>
        <section class="comments section modern-comments" id="commentsSection">
            <h2 class="comments-title">Comments</h2>
            <div class="login-prompt" id="loginPrompt">
                <p>
                    Please <a href="login.html" class="login-link">login</a> to comment and bookmark posts.
                </p>
            </div>
            <div class="comment-form-container">
                <form id="commentForm" class="comment-form">
                    <textarea 
                        class="comment-input"
                        name="comment" 
                        id="commentInput" 
                        placeholder="Write a comment..." 
                        required></textarea>
                    <button type="submit" class="comment-submit" id="commentSubmit" disabled>Post Comment</button>
                </form>
            </div>
            <div id="commentsList" class="comments-list"></div>
        </section>
    </main> 
    <script>

        // Toggle profile dropdown on mobile
        document.querySelector('.profile-picture').addEventListener('click', function(e) {
            e.stopPropagation();
            document.querySelector('.profile-dropdown').classList.toggle('active');
        });
        document.addEventListener('click', function() {
            document.querySelector('.profile-dropdown').classList.remove('active');
        });

        function updateMobileAuthButtons(isLoggedIn) {
            const mobileAuth = document.getElementById('mobileAuthButtons');
            if (isLoggedIn) {
                mobileAuth.innerHTML = `<button class="logout-btn" onclick="logout()">Logout</button>`;
            } else {
                mobileAuth.innerHTML = `
                <div class="auth-button login"><a href="login.html">Login</a></div>
                <div class="auth-button register"><a href="register.html">Register</a></div>
                `;
            }
        }
        // Utility to get query param
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        //Global variables
        let currentPost = null;
        let postId = null;
        let userLikedPost = false;
        let userBookmarkedPost = false;

        function isLoggedIn() {
            return !!localStorage.getItem('authToken');
        }
        function getCurrentUser() {
                return JSON.parse(localStorage.getItem('user') || '{}');
            }

        function isAuthorOrAdmin(post) {
                const user = getCurrentUser();
                return user.id === post.author?.id || user.role === 'admin';
            }

        function validateComment(text) {
                return text && text.trim().length > 0;
            }
        
        async function incrementViewCount() {
                try {
                    await fetch(`${API_BASE_URL}/api/posts/${postId}/view`, {
                        method: 'POST'
                    });
                } catch (error) {
                    console.error('Error incrementing view count:', error);
                }
            }
            
        async function fetchAndRenderPost() {
            postId = getQueryParam('id');
            if (!postId) {
                document.getElementById('postDetailContainer').innerHTML = '<div>Post not found.</div>';
                return;
            }
            try {
                await incrementViewCount();

                const response = await fetch(`${API_BASE_URL}/api/posts/${postId}`);
                if (!response.ok) throw new Error('Post not found');

                const post = await response.json();
                currentPost = post;
                
                document.getElementById('postDetailContainer').innerHTML = `
                    <h1 class="post-title">${post.title}</h1>
                    <div class="post-meta">
                        <span>By ${post.author?.username || 'Unknown'}</span> |
                        <span>${new Date(post.publishedAt || post.createdAt).toLocaleDateString()}</span>
                    </div>
                    <div class="post-image">
                        <img src="${post.imageUrl || './images/blogone.jpeg'}" alt="Post image">
                    </div>
                    <div class="post-content">${post.content}</div>
                `;
                if (isLoggedIn()) {
                    document.getElementById('postInteractions').style.display ='flex';
                    document.getElementById('commentsSection').style.display = 'block';
                    renderLikeBookmark(post);
                    fetchAndRenderComments();
                }
            } catch (error) {
                document.getElementById('postDetailContainer').innerHTML = '<div>Error loading post.</div>';
            }
        }


        function renderLikeBookmark(post) {
            // Like
            document.getElementById('likeCount').textContent = post.likes ? post.likes.length : 0;
            document.getElementById('likeBtn').onclick = async function() {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/posts/${post._id}/like`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('likeCount').textContent = data.likesCount;
                }
            };
            // Bookmark
            document.getElementById('bookmarkBtn').onclick = async function() {
                const token = localStorage.getItem('authToken');
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (!user || !user.id) return;
                const response = await fetch(`${API_BASE_URL}/api/users/me/bookmarks/${post._id}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    alert('Bookmarked!');
                }
            };
        }

        // Comments
        async function fetchAndRenderComments() {
            const response = await fetch(`${API_BASE_URL}/api/posts/${postId}/comments`);
            const comments = await response.json();
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';
            if (!Array.isArray(comments) || comments.length === 0) {
                commentsList.innerHTML = '<div>No comments yet.</div>';
                return;
            }
            comments.forEach(comment => {
                const div = document.createElement('div');
                div.className = 'comment';
                div.innerHTML = `
                    <b>${comment.author?.username || 'User'}:</b> ${comment.content}
                    <button class="reply-btn" data-comment-id="${comment._id}">Reply</button>
                    <div class="reply-box" id="reply-box-${comment._id}" style="display:none; margin-top:8px;">
                        <textarea id="reply-input-${comment._id}" placeholder="Write a reply..."></textarea>
                        <button onclick="postReply('${comment._id}')">Post Reply</button>
                    </div>
                    <div class="replies" id="replies-${comment._id}">
                        ${Array.isArray(comment.replies) && comment.replies.length > 0 ? comment.replies.map(reply => `
                            <div class="reply"><b>${reply.author?.username || 'User'}:</b> ${reply.content}</div>
                        `).join('') : ''}
                    </div>
                `;
                commentsList.appendChild(div);
            });
        }

        document.getElementById('commentsList').addEventListener('click', function(e) {
            // Reply button
            if (e.target.classList.contains('reply-btn')) {
                const commentId = e.target.getAttribute('data-comment-id');
                document.getElementById(`reply-box-${commentId}`).style.display = 'block';
            }
            // Post reply button
            if (e.target.textContent.trim() === 'Post Reply' && e.target.parentElement.classList.contains('reply-box')) {
                const commentId = e.target.parentElement.id.replace('reply-box-', '');
                postReply(commentId);
            }
        });

        // Post reply
        window.postReply = async function(commentId) {
            const token = localStorage.getItem('authToken');
            const input = document.getElementById(`reply-input-${commentId}`);
            const reply = input.value.trim();
            if (!reply) return;
            const response = await fetch(`${API_BASE_URL}/api/posts/${postId}/comments/${commentId}/reply`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ content: reply })
            });
            if (response.ok) {
                input.value = '';
                document.getElementById(`reply-box-${commentId}`).style.display = 'none';
                fetchAndRenderComments();
            }
        };

        const commentInput = document.getElementById('commentInput');
        const postCommentBtn = document.getElementById('commentSubmit');

        commentInput.addEventListener('input', function() {
            postCommentBtn.disabled = !commentInput.value.trim();
        });

        document.getElementById('commentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const token = localStorage.getItem('authToken');
            const content = document.getElementById('commentInput').value;
            if (!content) return;
            const response = await fetch(`${API_BASE_URL}/api/posts/${postId}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ content })
            });
            if (response.ok) {
                document.getElementById('commentInput').value = '';
                fetchAndRenderComments();
            }
        });
        document.addEventListener('DOMContentLoaded', fetchAndRenderPost);
    </script> 
</body>
</html> 